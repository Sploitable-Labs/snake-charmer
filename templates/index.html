<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Coding Challenges</title>
    <!-- Bootstrap CSS for basic layout -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <!-- Brython -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.10.3/brython.min.js"></script>
</head>
<body onload="brython()">
    <header class="bg-dark text-white py-3 d-flex justify-content-center align-items-center position-relative">
        <!-- Settings gear positioned on top-left with padding -->
        <div id="settings-banner" class="position-absolute" style="left: 2rem;">
            <i class="fas fa-cog settings-icon" id="settings-icon" title="Settings"></i>
        </div>
        
        <h1 class="text-center"><i class="fas fa-code"></i> Python Coding Challenges</h1>

        <!-- Score positioned on top-right with padding -->
        <div id="score-banner" class="position-absolute" style="right: 2rem;">
            <i class="fas fa-star star-icon"></i> <span id="score">{{ user_data.score }}</span>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Collapsible Challenge Selection Menu -->
            <div id="challenge-menu-outer" class="col-md-3 col-lg-3"    >
            <aside id="challenge-menu" class="challenge-menu">
                {% for category in challenges | groupby("category") | sort_ninja_last %}
                <div class="category">
                    <button class="category-title" data-bs-toggle="collapse" data-bs-target="#cat-{{ loop.index }}" aria-expanded="false" aria-controls="cat-{{ loop.index }}">
                        {{ category.grouper }} <i class="fas fa-chevron-down float-end"></i>
                    </button>
                    <div class="collapse category-items" id="cat-{{ loop.index }}">
                        {% for challenge in category.list %}
                        <button class="challenge-btn challenge-{{ challenge.difficulty | lower }}" data-id="{{ challenge.id }}">
                            <span id="challenge-name-{{ challenge.id }}">{{ challenge.name }}</span>
                            {% if challenge.id|string in user_data.completed_challenges|map('string') %}
                            <i class="fas fa-check-circle tick-mark"></i>
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <!-- Ninja Placeholder (Grayed Out and Clickable for Popup) -->
                {% if not session.get('ninja_unlocked', False) %}
                <div class="category grayed-out" id="ninja-placeholder">
                    <button class="category-title">
                        Ninja <i class="fas fa-lock float-end"></i>
                    </button>
                </div>
                {% endif %}
            </aside>
            </div>

            <!-- Center Column: Code Editor and Submit Button -->
            <main class="col-md-6 col-lg-6 d-flex flex-column align-items-center p-4">
                <!-- Centered Challenge Title -->
                <h2 id="challenge-title" class="text-center mb-3">Welcome!</h2>

                <div class="computer">
                    <div class="computer-frame computer-off">
                        <div id="challenge-media" class="media-container"></div>
                        <div id="input-container" class="mt-3"></div>
                        <div id="code-editor-container" class="code-editor-container">
                            <div id="code-editor"></div>
                        </div>
                        <div id="output" class="output-area"></div>
                    </div>
                    <div class="computer-base-upper"></div>
                    <div class="computer-base-lower"></div>
                </div>

                <div class="keyboard-container">
                <div id="keyboard">
                        <ul class="cf">
                            <li><a href="#" class="key c27 fn"><span id="esc">esc</span></a></li>
                            <li><a href="#" class="key c112 fn"><span>F1</span></a></li>
                            <li><a href="#" class="key c113 fn"><span>F2</span></a></li>
                            <li><a href="#" class="key c114 fn"><span>F3</span></a></li>
                            <li><a href="#" class="key c115 fn"><span>F4</span></a></li>
                            <li><a href="#" class="key c116 fn"><span>F5</span></a></li>
                            <li><a href="#" class="key c117 fn"><span>F6</span></a></li>
                            <li><a href="#" class="key c118 fn"><span>F7</span></a></li>
                            <li><a href="#" class="key c119 fn"><span>F8</span></a></li>
                            <li><a href="#" class="key c120 fn"><span>F9</span></a></li>
                            <li><a href="#" class="key c121 fn"><span>F10</span></a></li>
                            <li><a href="#" class="key c122 fn"><span>F11</span></a></li>
                            <li><a href="#" class="key c123 fn"><span>F12</span></a></li>
                            <li><a href="#" class="key fn"><span>Eject</span></a></li>
                        </ul>
                        <ul class="cf" id="numbers">
                            <li><a href="#" class="key c192"><b>~</b><span>`</span></a></li>
                            <li><a href="#" class="key c49"><b>!</b><span>1</span></a></li>
                            <li><a href="#" class="key c50"><b>@</b><span>2</span></a></li>
                            <li><a href="#" class="key c51"><b>#</b><span>3</span></a></li>
                            <li><a href="#" class="key c52"><b>$</b><span>4</span></a></li>
                            <li><a href="#" class="key c53"><b>%</b><span>5</span></a></li>
                            <li><a href="#" class="key c54"><b>^</b><span>6</span></a></li>
                            <li><a href="#" class="key c55"><b>&amp;</b><span>7</span></a></li>
                            <li><a href="#" class="key c56"><b>*</b><span>8</span></a></li>
                            <li><a href="#" class="key c57"><b>(</b><span>9</span></a></li>
                            <li><a href="#" class="key c48"><b>)</b><span>0</span></a></li>
                            <li><a href="#" class="key c189 alt"><b>_</b><span>-</span></a></li>
                            <li><a href="#" class="key c187"><b>+</b><span>=</span></a></li>
                            <li><a href="#" class="key c46" id="delete"><span>Delete</span></a></li>
                        </ul>
                        <ul class="cf" id="qwerty">
                            <li><a href="#" class="key c9" id="tab"><span>tab</span></a></li>
                            <li><a href="#" class="key c81"><span>q</span></a></li>
                            <li><a href="#" class="key c87"><span>w</span></a></li>
                            <li><a href="#" class="key c69"><span>e</span></a></li>
                            <li><a href="#" class="key c82"><span>r</span></a></li>
                            <li><a href="#" class="key c84"><span>t</span></a></li>
                            <li><a href="#" class="key c89"><span>y</span></a></li>
                            <li><a href="#" class="key c85"><span>u</span></a></li>
                            <li><a href="#" class="key c73"><span>i</span></a></li>
                            <li><a href="#" class="key c79"><span>o</span></a></li>
                            <li><a href="#" class="key c80"><span>p</span></a></li>
                            <li><a href="#" class="key c219 alt"><b>{</b><span>[</span></a></li>
                            <li><a href="#" class="key c221 alt"><b>}</b><span>]</span></a></li>
                            <li><a href="#" class="key c220 alt"><b>|</b><span>\</span></a></li>
                        </ul>
                        <ul class="cf" id="asdfg">
                            <li><a href="#" class="key c20 alt" id="caps"><b></b><span>caps lock</span></a></li>
                            <li><a href="#" class="key c65"><span>a</span></a></li>
                            <li><a href="#" class="key c83"><span>s</span></a></li>
                            <li><a href="#" class="key c68"><span>d</span></a></li>
                            <li><a href="#" class="key c70"><span>f</span></a></li>
                            <li><a href="#" class="key c71"><span>g</span></a></li>
                            <li><a href="#" class="key c72"><span>h</span></a></li>
                            <li><a href="#" class="key c74"><span>j</span></a></li>
                            <li><a href="#" class="key c75"><span>k</span></a></li>
                            <li><a href="#" class="key c76"><span>l</span></a></li>
                            <li><a href="#" class="key c186 alt"><b>:</b><span>;</span></a></li>
                            <li><a href="#" class="key c222 alt"><b>"</b><span>'</span></a></li>
                            <li><a href="#" class="key c13 alt" id="enter"><span>return</span></a></li>
                        </ul>
                        <ul class="cf" id="zxcvb">
                            <li><a href="#" class="key c16 shiftleft"><span>Shift</span></a></li>
                            <li><a href="#" class="key c90"><span>z</span></a></li>
                            <li><a href="#" class="key c88"><span>x</span></a></li>
                            <li><a href="#" class="key c67"><span>c</span></a></li>
                            <li><a href="#" class="key c86"><span>v</span></a></li>
                            <li><a href="#" class="key c66"><span>b</span></a></li>
                            <li><a href="#" class="key c78"><span>n</span></a></li>
                            <li><a href="#" class="key c77"><span>m</span></a></li>
                            <li><a href="#" class="key c188 alt"><b>&lt;</b><span>,</span></a></li>
                            <li><a href="#" class="key c190 alt"><b>&gt;</b><span>.</span></a></li>
                            <li><a href="#" class="key c191 alt"><b>?</b><span>/</span></a></li>
                            <li><a href="#" class="key c16 shiftright"><span>Shift</span></a></li>
                        </ul>
                        <ul class="cf" id="bottomrow">
                            <li><a href="#" class="key" id="fn"><span>fn</span></a></li>
                            <li><a href="#" class="key c17" id="control"><span>control</span></a></li>
                            <li><a href="#" class="key option" id="optionleft"><span>option</span></a></li>
                            <li><a href="#" class="key command" id="commandleft"><span>command</span></a></li>
                            <li><a href="#" class="key c32" id="spacebar"></a></li>
                            <li><a href="#" class="key command" id="commandright"><span>command</span></a></li>
                            <li><a href="#" class="key option" id="optionright"><span>option</span></a></li>
                            <ol class="cf">
                                    <li><a href="#" class="key c37" id="left"><span>&#9666;</span></a></li>
                                <li>
                                    <a href="#" class="key c38" id="up"><span>&#9652;</span></a>
                                        <a href="#" class="key c40" id="down"><span>&#9662;</span></a>
                                </li>
                                    <li><a href="#" class="key c39" id="right"><span>&#9656;</span></a></li>
                            </ol>
                        </ul>
                    </div>
                </div>
            </main>

            <!-- Right-Side Panel for Available Score and Hints -->
            <div id="hint-panel" class="col-md-3 col-lg-3 pt-3">
                <h4 class="mt-3">Available Score</h4>
                <div id="available-score">0</div>

                <!-- Instructions Section under Submit Button -->
                <h4 class="mt-3">Instructions</h4>
                <div id="instructions-content" class="instructions-box">
                    <div id="instructions-text">
                        <p>Select a challenge to see instructions.</p>
                    </div>
                </div>

                <!-- Container for dynamic hint buttons -->
                <h4 class="mt-3" id="hints-header" style="display: none;">Hints</h4>
                <div id="hint-buttons"></div>
                <div id="hint-content" class="mt-3"></div>

                <!-- Centered Submit Button -->
                <div id="submit-button-container">
                    <button id="submit-btn" class="btn btn-success mb-3" disabled><i class="fas fa-check"></i> Submit Answer</button>
                </div>      
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <a href="https://github.com/Sploitable-Labs" target="_blank">Sploitable Labs</a>
    </footer>

    <!-- Modal for Success/Failure Notifications -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <i id="modal-icon" class="fas fa-trophy fa-3x"></i>
            <p id="modal-message" class="mt-3"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Unlock Popup Modal -->
    <div id="unlock-popup" class="modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ninja Challenge</h5>
                    <button type="button" class="btn-close" onclick="closePopup()"></button>
                </div>
                <div class="modal-body text-center">
                    <i id="ninja-modal-icon" class="fas fa-user-ninja fa-3x"></i>
                    <p>To unlock the ninja challenge you need at least 500 points.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="close-unlock-modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Embedding challenges data for JavaScript access -->
    <script>
        const challengeData = {{ challenges | tojson }};
    </script>

    <!-- Bootstrap and Custom JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="theme-select">Editor Theme:</label>
                    <select id="theme-select" class="form-select">
                        <option value="monokai">Monokai</option>
                        <option value="solarized_dark">Solarized Dark</option>
                        <option value="solarized_light">Solarized Light</option>
                        <option value="github">GitHub</option>
                        <!-- Add more themes as needed -->
                    </select>

                    <label for="font-size-input" class="mt-3">Font Size (px):</label>
                    <input type="number" id="font-size-input" class="form-control" min="10" max="48" value="18">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="apply-settings">Apply</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<script type="text/python">
from browser import document, console, window

# Sounds
success_sound = window.Audio.new("/static/sounds/success.mp3")
fail_sound = window.Audio.new("/static/sounds/fail.mp3")
error_sound = window.Audio.new("/static/sounds/error.mp3")
hint_sound = window.Audio.new("/static/sounds/hint.mp3")
ninja_unlock_sound = window.Audio.new("/static/sounds/ninja_unlock.mp3")
ninja_success_sound = window.Audio.new("/static/sounds/ninja_success.mp3")

# Function to show a modal
def show_modal(title, message, icon_class, on_close=None):
    document["notificationModalLabel"].text = title
    document["modal-message"].text = message
    document["modal-icon"].className = icon_class
    window.bootstrap.Modal.new(document["notificationModal"]).show()

    if on_close:
        def handle_hidden(event):
            on_close()
            document.getElementById('notificationModal').removeEventListener("hidden.bs.modal", handle_hidden)

        document.getElementById('notificationModal').addEventListener("hidden.bs.modal", handle_hidden)

# Function to fetch arguments (only for code challenges)
def fetch_arguments(callback):
    console.log("Fetching arguments.")

    if window.current_challenge["type"] != "code":
        console.log("Non-code challenge, skipping fetch_arguments.")
        return

    challenge_id = window.challenge_id
    if not challenge_id:
        console.log("No challenge selected.")
        return

    def on_complete(req):
        console.log("Request complete.")
        try:
            response_data = window.JSON.parse(req.responseText)
            if response_data["success"]:
                test_arguments = response_data["test_arguments"]
                callback(test_arguments)
            else:
                console.log("Error: Failed to fetch arguments.")
        except Exception as e:
            console.log("Error processing response:", str(e))

    req = window.XMLHttpRequest.new()
    req.open('GET', f'/get_test_arguments?challenge_id={challenge_id}', True)
    req.bind('load', lambda _: on_complete(req))
    req.send()

# Function to run user code or process non-code challenges
def run_user_code(event):
    console.log("Running user code.")
    challenge_id = window.challenge_id
    if not challenge_id:
        show_modal("Warning", "Please select a challenge.", "fas fa-exclamation-triangle text-warning")
        return

    console.log("dbg 1")
    console.log(window.current_challenge)
    challenge_type = window.current_challenge["type"] if "type" in window.current_challenge else "code"
    console.log("dbg 2")
    if challenge_type == "code":
        run_code_challenge()
    else:
        run_non_code_challenge()

# Function to run code challenges
def run_code_challenge():
    console.log("Running code challenge.")

    user_code = window.editor.getValue()
    output_area = document["output"]
    results = []
    local_scope = {}

    def execute_with_arguments(js_test_cases):
        console.log("Executing code with arguments.")
        try:
            exec(user_code, {}, local_scope)
            if 'foo' in local_scope:
                foo = local_scope['foo']
                console.log(f"foo: {foo}")

                output_area.text = ""
                test_cases = convert_test_cases(js_test_cases)
                
                for test_case in test_cases:       
                    result = foo(*test_case)
                    console.log(f"Test case: {test_case}, Result: {result}")
                    output_area.text += str(result) + "\n"
                    results.append(result)
                submit_results(results)
            else:
                output_area.text = "Error: Function 'foo' not found in code."
                error_sound.play()

        except Exception as e:
            output_area.text = f"Error: {str(e)}"
            error_sound.play()

    fetch_arguments(execute_with_arguments)

# Function to handle non-code challenges
def run_non_code_challenge():
    console.log("Running non-code challenge.")
    user_response = document["user-response"].value.strip().lower()
    if not user_response:
        show_modal("Error", "Please enter a response.", "fas fa-times-circle text-danger")
        return

    # Submit the response to the server
    submit_results(user_response=user_response)

# Function to submit results
def submit_results(results=None, user_response=None):
    console.log("Submitting results.")
    challenge_id = window.challenge_id

    data = {
        "challenge_id": challenge_id,
    }
    if results:
        data["results"] = results
    if user_response:
        data["user_answer"] = user_response

    def on_success(req):
        console.log("Results submitted successfully.")
        try:
            response_data = window.JSON.parse(req.responseText)
            if response_data["success"]:
                show_modal(
                    "Congratulations!",
                    f"You earned {response_data['challenge_score']} points.",
                    "fas fa-trophy text-success"
                )
                success_sound.play()
                
                # Update client-side user_data with latest score and completed challenges
                window.user_data["score"] = response_data["score"]
                window.user_data["completed_challenges"] = response_data["completed_challenges"]

                active_challenge = document.querySelector('.challenge-btn.active-challenge')
                if active_challenge and not active_challenge.select_one('.tick-mark'):
                    active_challenge.innerHTML += ' <i class="fas fa-check-circle tick-mark"></i>'
                
                document["score"].text = str(response_data["score"])

                # Reset available score to zero in the DOM
                document["available-score"].text = "0"

                # Disable the submit button
                document["submit-btn"].disabled = True

                # Select all elements with the class "hint-btn"
                hint_buttons = document.select(".hint-btn")

                # Loop through each button and set disabled to True
                for button in hint_buttons:
                    button.disabled = True


            else:
                show_modal("Try Again!", "Incorrect response. Please try again.", "fas fa-times-circle text-danger")
                fail_sound.play()
        except Exception as e:
            show_modal("Error", "An error occurred while submitting the results.", "fas fa-exclamation-triangle text-warning")
            error_sound.play()

    def on_failure(req):
        console.error("Error submitting results:", req)
        show_modal("Error", "An error occurred while submitting the results.", "fas fa-exclamation-triangle text-warning")
        error_sound.play()

    req = window.XMLHttpRequest.new()
    req.bind("load", lambda e: on_success(req) if req.status == 200 else on_failure(req))
    req.open("POST", "/submit_results", True)
    req.setRequestHeader("Content-Type", "application/json")
    req.send(window.JSON.stringify(data))   

def is_iterable(obj):
    try:
        iter(obj)  # Attempt to get an iterator from the object
        return True
    except TypeError:  # If it raises TypeError, it's not iterable
        return False

def convert_test_cases(js_test_cases):
    num_test_cases = len(js_test_cases)
    test_cases = []
    for idx in range(num_test_cases):
        js_test_case = js_test_cases[idx]
        test_case = []
        for js_arg in js_test_case:
            if is_iterable(js_arg) and not isinstance(js_arg, str) and not isinstance(js_arg, list):
                arg = dict(js_arg)
            else:
                arg = js_arg
            test_case.append(arg)
        test_cases.append(test_case)
    return test_cases

# Attach run_user_code to the submit button
document["submit-btn"].bind("click", run_user_code)
</script>

<script type="text/javascript">
    window.user_data = {{ user_data | tojson }};
</script>

</body>
</html>
